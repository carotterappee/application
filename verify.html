<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Vérifie ton email | HP+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css">
  <style>
    body{
      font-family:"Syne",system-ui,sans-serif;
      background: linear-gradient(135deg,#f0f4ff,#fafaff);
      min-height:100vh; margin:0;
      display:flex; align-items:center; justify-content:center;
    }
    .verify-box{
      width:100%; max-width:420px; background:#fff; border-radius:16px;
      box-shadow:0 10px 30px rgba(70,90,200,.15);
      padding:26px; text-align:center;
    }
    h1{ font-size:clamp(22px,4vw,28px); font-weight:800; color:#3446d4; margin:0 0 10px;}
    p{ color:#334155; margin:8px 0;}
    .hint{ color:#7a86b6; font-size:.95rem; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:16px;}
    .btn{ padding:12px 16px; border-radius:12px; font-weight:800; cursor:pointer; border:1px solid #ccd4f5; background:#fff; color:#3f51b5;}
    .btn.primary{ background:#3f51b5; color:#fff; border:none; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .back-top{
      position:fixed; left:14px; top:14px; width:36px; height:36px; border:none; background:none; cursor:pointer;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%233F51B5" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>') no-repeat center/70%;
      opacity:.85;
    }
    .back-top:hover{ opacity:1; }
    .ok{ color:#19a55a; font-weight:800; }
    .err{ color:#d43f3a; font-weight:800; }
  </style>
</head>
<body>
  <button class="back-top" onclick="goHome()" aria-label="Retour"></button>

  <div class="verify-box">
    <h1>Vérifie ton email</h1>
    <p>Nous t’avons envoyé un lien de confirmation à <span id="userMail">ton adresse</span>.</p>
    <p class="hint">⚠️ Pense à vérifier les <strong>indésirables</strong> si tu ne le vois pas.</p>
    <div id="status" class="hint"></div>

    <div class="actions">
      <button id="refreshBtn" class="btn primary" onclick="checkVerified()">J’ai cliqué sur le lien ✅</button>
      <button id="resendBtn" class="btn" onclick="resend()">Renvoyer l’email</button>
      <button class="btn" onclick="goHome()">Retour à l’accueil</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, sendEmailVerification 
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD6G4vBBBCZdVkXKUZTPxGZOOAegzLvcqI",
      authDomain: "appli-hp.firebaseapp.com",
      projectId: "appli-hp",
      storageBucket: "appli-hp.firebasestorage.app",
      messagingSenderId: "339454204045",
      appId: "1:339454204045:web:75f349c8f1f90e4399eac4",
      measurementId: "G-PKTXGQ1DC7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const mailEl = document.getElementById('userMail');
    const statusEl = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');
    const resendBtn  = document.getElementById('resendBtn');

    function setBusy(b){
      refreshBtn.disabled = b;
      resendBtn.disabled  = b;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // pas loggé → on revient au login
        window.location.href = "login.html";
        return;
      }
      mailEl.textContent = user.email || "ton email";
      await user.reload();
      if (user.emailVerified) {
        window.location.href = "dashboard.html";
      }
    });

    // Vérifie à la demande si la vérif est faite
    window.checkVerified = async function(){
      const u = auth.currentUser;
      if (!u) return;
      setBusy(true);
      statusEl.textContent = "Vérification en cours…";
      try{
        await u.reload();
        if (u.emailVerified) {
          statusEl.innerHTML = '<span class="ok">Email vérifié !</span>';
          window.location.href = "dashboard.html";
        } else {
          statusEl.innerHTML = '<span class="err">Pas encore vérifié. Clique sur le lien dans l’email.</span>';
        }
      } finally {
        setBusy(false);
      }
    }

    // Renvoyer l’email
    window.resend = async function(){
      const u = auth.currentUser;
      if (!u) return;
      setBusy(true);
      statusEl.textContent = "Envoi en cours…";
      try{
        await sendEmailVerification(u);
        statusEl.innerHTML = '<span class="ok">Email renvoyé ✔︎</span>';
      } catch(e){
        statusEl.innerHTML = '<span class="err">Impossible de renvoyer. Réessaie plus tard.</span>';
      } finally {
        setBusy(false);
      }
    }

    window.goHome = function(){
      window.location.href = "index.html";
    }
  </script>
</body>
</html>

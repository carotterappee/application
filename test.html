<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Test de niveau | HP+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css">
  <style>
    body{ font-family: "Syne", system-ui, sans-serif; background: #f7f9ff; margin:0; }
    .wrap{ max-width: 840px; margin: 28px auto; padding: 0 16px; }
    .card{ background:#fff; border:1px solid #e7ebff; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(70,90,200,.10); }
    h1{ margin: 0 0 8px; color:#3446d4; font-weight:800; }
    .muted{ color:#5b6aa9; }
    .progress{ height:8px; background:#eef1fb; border-radius:999px; overflow:hidden; margin:16px 0 20px; }
    .bar{ height:100%; width:0; background: linear-gradient(135deg, #7b88ff, #c4ceff); transition:width .25s ease; }
    .q-title{ font-weight:800; margin: 8px 0 12px; }
    .choices{ display:grid; gap:10px; }
    .choice{
      border:1px solid #e7ebff; border-radius:12px; padding:12px; background:#fff; cursor:pointer;
    }
    .choice input{ margin-right:8px; }
    .row{ display:flex; gap:10px; justify-content:space-between; margin-top:16px; }
    .btn{ padding:12px 16px; border-radius:12px; border:1px solid #e7ebff; background:#fff; font-weight:700; cursor:pointer; }
    .btn.primary{ background:#3f51b5; color:#fff; border-color:transparent; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .center{ text-align:center; }
    .badge{ display:inline-block; padding:10px 14px; border-radius:999px; background:#f0f4ff; border:1px solid #dfe6ff; font-weight:800; color:#2f43c8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="intro">
      <h1>Test de niveau (FR)</h1>
      <p class="muted">Un court test inspir√© du TCF pour estimer ton niveau. R√©ponds sans stress üòâ</p>
      <ul class="muted">
        <li>Dur√©e : ~3‚Äì5 minutes</li>
        <li>1 seule r√©ponse par question</li>
        <li>√Ä la fin : estimation CECR (A1 ‚Üí C1/C2)</li>
      </ul>
      <div class="center">
        <button class="btn primary" onclick="start()">Commencer</button>
      </div>
    </div>

    <div class="card" id="quiz" style="display:none;">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div id="qNumber" class="muted"></div>
      <div id="qTitle" class="q-title"></div>
      <div id="choices" class="choices"></div>
      <div class="row">
        <button class="btn" id="prevBtn" onclick="prev()" disabled>‚Üê Pr√©c√©dent</button>
        <button class="btn primary" id="nextBtn" onclick="next()" disabled>Suivant ‚Üí</button>
      </div>
    </div>

    <div class="card" id="result" style="display:none;">
      <h1>R√©sultat</h1>
      <p class="muted">Voici ton estimation de niveau :</p>
      <p class="center"><span id="levelBadge" class="badge">‚Ä¶</span></p>
      <p class="center" id="scoreText" style="margin-top:8px;"></p>
      <div class="center" style="margin-top:16px;">
        <button class="btn" onclick="window.location.href='dashboard.html'">‚Üê Retour au dashboard</button>
        <button class="btn primary" onclick="goToLesson()">Commencer les le√ßons</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD6G4vBBBCZdVkXKUZTPxGZOOAegzLvcqI",
      authDomain: "appli-hp.firebaseapp.com",
      projectId: "appli-hp",
      storageBucket: "appli-hp.firebasestorage.app",
      messagingSenderId: "339454204045",
      appId: "1:339454204045:web:75f349c8f1f90e4399eac4",
      measurementId: "G-PKTXGQ1DC7"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // --- Banque de questions (exemples rapides) ---
    // tip: ajoute-en beaucoup + par "difficult√©" pour affiner la map vers CECR
    const QUESTIONS = [
      // A1-A2
      { id:1, text:"Choisis la bonne suite: ¬´ Bonjour, √ßa va ? ‚Äî ‚Ä¶ ¬ª", choices:["√áa va bien, merci.","Je suis √† la gare.","Hier, j‚Äôirai au parc."], correct:0, weight:1 },
      { id:2, text:"Quel est le pluriel de ¬´ un animal ¬ª ?", choices:["des animals","des animaux","des animal"], correct:1, weight:1 },
      // B1
      { id:3, text:"Compl√®te: ¬´ Il faut que tu ___ plus t√¥t demain. ¬ª", choices:["pars","part","partes"], correct:0, weight:2 },
      { id:4, text:"Quel synonyme est le plus proche de ¬´ n√©anmoins ¬ª ?", choices:["cependant","donc","ensuite"], correct:0, weight:2 },
      // B2
      { id:5, text:"Trouve la faute: ¬´ Bien qu‚Äôil pleuvait, nous sommes sortis. ¬ª", choices:["¬´ pleuvait ¬ª","¬´ nous sommes sortis ¬ª","aucune faute"], correct:0, weight:3 },
      // C1/C2
      { id:6, text:"Lequel illustre une concession renforc√©e ?", choices:[
        "Il a r√©ussi parce qu‚Äôil a travaill√©.",
        "Il a beau travailler, il n‚Äôobtient pas de r√©sultats.",
        "D√®s qu‚Äôil travaille, il r√©ussit."
      ], correct:1, weight:4 },
    ];

    // --- √âtat du test ---
    let current = 0;
    const answers = new Array(QUESTIONS.length).fill(null);
    let USER = null;

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);
    const show = (id, on=true) => $(id).style.display = on ? 'block' : 'none';

    onAuthStateChanged(auth, (user) => {
      USER = user || null;
      // on autorise le test m√™me en non connect√©, mais on ne sauvegardera que si USER existe
    });

    // D√©marrer
    window.start = () => {
      show("intro", false);
      show("quiz",  true);
      render();
    };

    // Rendu question
    function render(){
      const q = QUESTIONS[current];
      $("qNumber").textContent = `Question ${current+1} / ${QUESTIONS.length}`;
      $("qTitle").textContent  = q.text;

      const ctn = $("choices");
      ctn.innerHTML = "";
      q.choices.forEach((label, idx) => {
        const id = `c_${current}_${idx}`;
        const wrap = document.createElement("label");
        wrap.className = "choice";
        wrap.innerHTML = `
          <input type="radio" name="choice" id="${id}" ${answers[current]===idx?'checked':''}>
          <span>${label}</span>
        `;
        wrap.onclick = () => {
          answers[current] = idx;
          $("nextBtn").disabled = false;
        };
        ctn.appendChild(wrap);
      });

      // boutons
      $("prevBtn").disabled = (current === 0);
      $("nextBtn").textContent = (current === QUESTIONS.length-1) ? "Valider" : "Suivant ‚Üí";
      $("nextBtn").disabled = (answers[current] === null);

      // barre
      $("bar").style.width = `${(current/QUESTIONS.length)*100}%`;
    }

    window.prev = () => { if (current>0){ current--; render(); } };
    window.next = () => {
      // si derni√®re ‚Üí corriger / scorer
      if (current === QUESTIONS.length-1){
        finish();
      } else {
        current++;
        render();
      }
    };

    // Score ‚Üí niveau
    function computeScore(){
      let raw = 0;
      let max = 0;
      QUESTIONS.forEach((q, i) => {
        max += q.weight;
        if (answers[i] === q.correct) raw += q.weight;
      });
      const pct = Math.round((raw / max) * 100);

      // mapping simple (√† affiner quand tu auras + de questions)
      let level = "A1";
      if (pct >= 20) level = "A2";
      if (pct >= 40) level = "B1";
      if (pct >= 65) level = "B2";
      if (pct >= 85) level = "C1/C2";

      return { raw, max, pct, level };
    }

    async function finish(){
      // compl√©ter barre
      $("bar").style.width = `100%`;

      const { raw, max, pct, level } = computeScore();

      // sauvegarde Firestore si connect√©
      try{
        if (USER){
          const ref = doc(db, "users", USER.uid);
          // merge: on n‚Äô√©crase pas le reste
          await setDoc(ref, {
            placement: {
              test: "TCF-lite",
              raw, max, pct, level,
              takenAt: serverTimestamp()
            },
            progress: {
              // on initialise une base (sans √©craser l‚Äôexistant si pr√©sent)
              level, // ex: "B1"
              updatedAt: serverTimestamp()
            }
          }, { merge:true });
        }
      }catch(e){ console.warn("save placement error", e); }

      // afficher r√©sultat
      $("levelBadge").textContent = level;
      $("scoreText").textContent  = `Score: ${raw} / ${max} (${pct}%)`;
      show("quiz", false);
      show("result", true);
    }

    // Redirection vers une le√ßon selon le niveau
    window.goToLesson = () => {
      // r√®gle simple: A1‚Üí lesson-1, A2‚Üí lesson-2, etc. (√† adapter)
      const { level } = computeScore();
      const map = { "A1":"lesson-1", "A2":"lesson-2", "B1":"lesson-3", "B2":"lesson-4", "C1/C2":"lesson-5" };
      const target = map[level] || "lesson-1";
      // pour l‚Äôinstant on alerte; chez toi : window.location.href=`${target}.html`;
      window.location.href = "dashboard.html";
    };
  </script>
</body>
</html>

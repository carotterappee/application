<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HP+ - Tableau de bord</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css?v=dashboard-v2"/>
  <style>
    /* ‚Äî mini styles sp√©cifiques au dashboard (peuvent rester ici) ‚Äî */
    #dashboard { max-width: 1040px; margin: 28px auto; padding: 0 20px; position:relative; }
    .dash-top{ position:relative; padding: 8px 0 18px; padding-right: 160px; }
    .dash-welcome{
      font-family:"Syne", system-ui, sans-serif; font-weight:800;
      font-size: clamp(22px, 4vw, 34px); color:#3446d4; margin: 10px 0 0;
    }
    .dash-sub{ color:#667085; margin:6px 0 0; }
    .dash-mascot{ position:absolute; right:16px; top:-10px; width:120px; height:120px; pointer-events:none; }
    @media (max-width:640px){
      .dash-top{ padding-right:112px; }
      .dash-mascot{ width:96px; height:96px; top:-4px; right:10px; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">HP+</div>
    <button class="icon-btn settings-btn" onclick="openSettings()" aria-label="Param√®tres"></button>
  </header>

  <main id="dashboard">

    <!-- Ici on colle le bloc profil -->
    <div class="dash-profile">
      <h2 id="dashWelcome">Bienvenue üëã</h2>
      <p><strong>Pseudo :</strong> <span id="profName">‚Ä¶</span></p>
      <p><strong>Email :</strong> <span id="profMail">‚Ä¶</span></p>
      <p><strong>XP :</strong> <span id="profXp">0</span></p>
      <p><strong>Inscrit le :</strong> <span id="profCreated">‚Ä¶</span></p>
    </div>

    <!-- En-t√™te + mascotte -->
    <div class="dash-top">
      <div class="dash-mascot" aria-hidden="true">
        <!-- Mini mascotte chat avec queue -->
        <svg viewBox="0 0 220 220" class="mascot-svg" role="img" aria-label="Chat noir kawaii">
          <defs>
            <style>
              .fur { fill:#0b0b0e; }
              .eye { fill:#ffe0a8; }
              .pupil { fill:#111; }
              .nose { fill:#2b2b2b; }
              .bow  { fill:#ff66a6; }
              .bow-dark { fill:#ff4d98; }
              .scarf { fill:#ff6fae; }
              .scarf2{ fill:#ff5ea2; }
              @keyframes blink {0%,96%,100%{transform:scaleY(1);}97%,99%{transform:scaleY(.1);} }
            </style>
          </defs>
          <!-- Queue -->
          <path d="M150,160 q20,10 10,30 q-15,18 -30,6"
                fill="none" stroke="#0b0b0e" stroke-width="16" stroke-linecap="round"/>
          <g transform="translate(0,6)">
            <ellipse class="fur" cx="110" cy="142" rx="50" ry="58"/>
            <g transform="translate(0,-10)">
              <circle class="fur" cx="110" cy="78" r="46"/>
              <!-- Oreilles -->
              <path class="fur" d="M80,56 l-15,-16 a6,6 0 0 1 8,-8 l18,12z"/>
              <path class="fur" d="M140,56 l15,-16 a6,6 0 0 0 -8,-8 l-18,12z"/>
              <!-- Noeud -->
              <g transform="translate(122,38) rotate(-8)">
                <ellipse class="bow" cx="0" cy="0" rx="7" ry="5"/>
                <path class="bow-dark" d="M-7,0 C-16,-6,-15,8,-7,5 C-12,10,-10,16,-3,8 Z"/>
                <path class="bow-dark" d="M7,0 C16,-6,15,8,7,5 C12,10,10,16,3,8 Z"/>
              </g>
              <!-- Yeux -->
              <g transform="translate(86,78)">
                <g style="transform-origin:0 0; animation: blink 4.6s infinite;">
                  <circle class="eye" cx="0" cy="0" r="10"/>
                </g>
                <circle class="pupil" cx="0" cy="0" r="4"/>
              </g>
              <g transform="translate(134,78)">
                <g style="transform-origin:0 0; animation: blink 5.1s infinite .12s;">
                  <circle class="eye" cx="0" cy="0" r="10"/>
                </g>
                <circle class="pupil" cx="0" cy="0" r="4"/>
              </g>
              <ellipse class="nose" cx="110" cy="92" rx="4" ry="3"/>
            </g>
            <!-- √âcharpe -->
            <g>
              <path class="scarf" d="M78,116 q32,-10 64,0 q-8,12 -32,12 q-24,0 -32,-12z"/>
              <path class="scarf2" d="M142,118 q10,12 -4,26 q-10,12 -16,2"/>
            </g>
          </g>
        </svg>
        <!-- Coffre √† tr√©sor -->
  <a href="chest.html" class="treasure-link" title="Voir mes r√©compenses">
    <svg viewBox="0 0 64 64" class="treasure-svg">
      <rect x="8" y="20" width="48" height="30" rx="4" ry="4" fill="#d4a05a" stroke="#8b5e3c" stroke-width="3"/>
      <rect x="8" y="12" width="48" height="12" rx="3" ry="3" fill="#c68642" stroke="#8b5e3c" stroke-width="3"/>
      <line x1="32" y1="20" x2="32" y2="50" stroke="#8b5e3c" stroke-width="4"/>
      <circle cx="32" cy="35" r="3" fill="#222"/>
    </svg>
  </a>
      </div>
      <!-- Coffre (bouton d'acc√®s inventaire) -->

      <h1 id="dashWelcome" class="dash-welcome" style="display:none;"></h1>
      <p id="dashSub" class="dash-sub" style="display:none;">Ravi de te revoir, pr√™t(e) √† continuer ?</p>
    </div>

    <!-- Grille de stats (XP + Streak) -->
    <section class="stats-grid">
      <div class="card">
        <div class="card-title">XP du jour</div>
        <div class="stars" id="xpStars"></div>
        <div class="muted small">Objectif : <span id="xpTarget">50</span> XP</div>
      </div>

      <div class="card">
        <div class="card-title">Momentum</div>
        <div class="streak-row">
          <div class="flame l1" id="streakFlame"></div>
          <div class="streak-days"><span id="streakDays">0</span> jours d‚Äôaffil√©e</div>
        </div>
        <div class="muted small">Garde le rythme üîÅ</div>
      </div>
    </section>

    <!-- CTA principal -->
    <section class="primary-cta two-btns">
      <button id="lessonBtn" class="btn-big" onclick="startOrContinue()">Commencer ta le√ßon</button>
      <button id="testBtn" class="btn-big secondary" onclick="startTest()">Test de niveau</button>
    </section>

    <!-- Modules (placeholders) -->
    <section class="modules" id="modulesSection" style="display:none;">
      <h2 class="h2" id="modulesTitle">Continuer o√π tu t‚Äôes arr√™t√©</h2>
      <div class="modules-grid" id="modulesGrid"></div>
    </section>

    <!-- Actions rapides -->
    <section class="quick-actions">
  </main>

  <script>
    // ---- Bienvenue conditionnelle
    (function initWelcome(){
      let prof = null;
      try{ prof = JSON.parse(localStorage.getItem('hp_profile') || 'null'); }catch(e){}
      const welcome = document.getElementById('dashWelcome');
      const sub = document.getElementById('dashSub');

      if(prof && !prof.guest && prof.displayName){
        welcome.textContent = `Bienvenue sur ton espace, ${prof.displayName} !`;
        welcome.style.display = 'block';
        sub.style.display = 'block';
      } else {
        welcome.style.display = 'none';
        sub.style.display = 'none';
      }
    })();

    // ---- Progression locale & CTA
    function getProgress(){
      try{
        const raw = localStorage.getItem('hp_progress');
        if(raw) return JSON.parse(raw);
      }catch(e){}
      const initial = { started:false, lastLessonId:null, updatedAt:null, xpToday: 0, xpTarget: 50, streakDays: 0 };
      localStorage.setItem('hp_progress', JSON.stringify(initial));
      return initial;
    }
    function setProgress(p){ localStorage.setItem('hp_progress', JSON.stringify(p)); }

    (function initLessonCta(){
      const btn = document.getElementById('lessonBtn');
      const prog = getProgress();
      btn.textContent = prog.started ? 'Continuer ta le√ßon' : 'Commencer ta le√ßon';
    })();

    function startOrContinue(){
      const prog = getProgress();
      if(!prog.started){
        prog.started = true;
        prog.lastLessonId = 'lesson-1';
      }
      prog.updatedAt = new Date().toISOString();
      setProgress(prog);
      // TODO: page de cours r√©elle
      // window.location.href = 'lesson.html';
      alert(prog.started ? 'On reprend ta le√ßon.' : 'On commence la le√ßon 1 !');
    }

    function openLesson(id){
      const prog = getProgress();
      prog.started = true;
      prog.lastLessonId = id;
      prog.updatedAt = new Date().toISOString();
      setProgress(prog);
      // TODO: navigation
      // window.location.href = `${id}.html`;
      alert('Ouverture: ' + id);
    }

    function logout(){
      localStorage.removeItem('hp_profile');
      // on ne supprime pas la progression pour l‚Äôinstant
      window.location.href = 'index.html';
    }

    // ---- Rendu XP (√©toiles argent√©es) & Streak (flamme)
    function renderXpStars(xpToday, xpTarget = 50){
      const count = Math.max(0, Math.min(5, Math.round((xpToday/xpTarget)*5)));
      const wrap = document.getElementById('xpStars'); wrap.innerHTML='';
      for(let i=0;i<5;i++){
        const s = document.createElement('span');
        s.className = 'star' + (i < count ? ' filled' : '');
        wrap.appendChild(s);
      }
      document.getElementById('xpTarget').textContent = xpTarget;
    }
    function updateStreak(days){
      const el = document.getElementById('streakFlame');
      const t = document.getElementById('streakDays');
      if(t) t.textContent = days;
      const lvl = days>=30 ? 5 : days>=14 ? 4 : days>=7 ? 3 : days>=3 ? 2 : 1;
      el.className = 'flame l' + lvl;
    }

    // ---- Init widgets (donn√©es simul√©es pour l‚Äôinstant)
    (function initWidgets(){
      const p = getProgress();
      // Valeurs par d√©faut si absentes
      const xp = typeof p.xpToday === 'number' ? p.xpToday : 34;
      const target = typeof p.xpTarget === 'number' ? p.xpTarget : 50;
      const streak = typeof p.streakDays === 'number' ? p.streakDays : 4;
      renderXpStars(xp, target);
      updateStreak(streak);
    })();
    function openSettings(){
    window.location.href = "settings.html";
  }

  function startTest(){
    alert("Lancement du test de niveau (√† d√©velopper) !");
   } 
   // --- helper pour cr√©er une carte le√ßon
function createLessonCard({id, title, progress=0}){
  const wrap = document.createElement('article');
  wrap.className = 'module-card';
  wrap.innerHTML = `
    <div class="module-title">${title}</div>
    <div class="progress"><div class="bar" style="width:${Math.max(0, Math.min(100, progress))}%;"></div></div>
    <button class="mini" onclick="openLesson('${id}')">Ouvrir</button>
  `;
  return wrap;
}

// --- rend les modules selon l'√©tat de progression
function renderModules(){
  const section = document.getElementById('modulesSection');
  const grid = document.getElementById('modulesGrid');
  const title = document.getElementById('modulesTitle');
  if(!section || !grid || !title) return;

  const p = getProgress();
  grid.innerHTML = '';

  if(!p.started){
    // Premi√®re fois ‚Üí une seule carte, Le√ßon 1
    title.textContent = "Commencer avec la premi√®re le√ßon";
    grid.appendChild(createLessonCard({
      id: 'lesson-1',
      title: 'Le√ßon 1 ¬∑ Salutations',
      progress: 0
    }));
    section.style.display = 'block';
  }else{
    // D√©j√† commenc√© ‚Üí 3 cartes (comme avant)
    title.textContent = "Continuer o√π tu t‚Äôes arr√™t√©";
    const lessons = [
      { id:'lesson-1', title:'Le√ßon 1 ¬∑ Salutations', progress: 62 },
      { id:'lesson-2', title:'Le√ßon 2 ¬∑ Chiffres',    progress: 28 },
      { id:'lesson-3', title:'Le√ßon 3 ¬∑ Famille',     progress: 0  },
    ];
    lessons.forEach(l => grid.appendChild(createLessonCard(l)));
    section.style.display = 'block';
  }
}

// --- initialise le CTA (d√©j√† pr√©sent chez toi, on garde la logique)
(function initLessonCta(){
  const btn = document.getElementById('lessonBtn');
  const prog = getProgress();
  btn.textContent = prog.started ? 'Continuer ta le√ßon' : 'Commencer ta le√ßon';
})();

// --- appelle le rendu des modules au chargement
renderModules();

function openChest(){
  window.location.href = 'chest.html';
}

/* R√©compenses: utilitaires */
function getRewards(){
  try{ return JSON.parse(localStorage.getItem('hp_rewards')||'null') || {}; }catch(e){ return {}; }
}
function setRewards(r){ localStorage.setItem('hp_rewards', JSON.stringify(r)); }

/* Appelle ceci quand une le√ßon est finie pour donner des √©toiles */
function awardStars(n = 5){
  const r = getRewards();
  r.starsTotal = (r.starsTotal || 0) + n;
  // Historique par jour (facultatif)
  const d = new Date().toISOString().slice(0,10);
  r.starsByDay = r.starsByDay || {};
  r.starsByDay[d] = (r.starsByDay[d] || 0) + n;
  setRewards(r);
  // Mets aussi √† jour l'XP du jour si tu veux synchroniser
  const p = getProgress();
  p.xpToday = (p.xpToday || 0) + n*10; // ex: 1 √©toile = 10 XP (√† adapter)
  setProgress(p);
  renderXpStars(p.xpToday, p.xpTarget || 50);
}
function popLastEarnedStar(){
  const row = document.querySelector('.xp-stars');
  if(!row) return;
  const filled = row.querySelectorAll('.star.filled');
  const last = filled[filled.length - 1];
  if(last){
    last.classList.add('earned');
    setTimeout(()=> last.classList.remove('earned'), 500);
  }
}
  </script>
  <!-- Charge le profil Firestore et remplit le dashboard -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD6G4vBBBCZdVkXKUZTPxGZOOAegzLvcqI",
    authDomain: "appli-hp.firebaseapp.com",
    projectId: "appli-hp",
    storageBucket: "appli-hp.firebasestorage.app",
    messagingSenderId: "339454204045",
    appId: "1:339454204045:web:75f349c8f1f90e4399eac4",
    measurementId: "G-PKTXGQ1DC7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    try {
      const snap = await getDoc(doc(db, "users", user.uid));
      if (snap.exists()) {
        const data = snap.data();
        const name = data.displayName || "invit√©";

        const h = document.getElementById("dashWelcome");
        if (h) { h.textContent = `Bienvenue sur ton espace, ${name} !`; h.style.display = "block"; }

        const sub = document.getElementById("dashSub");
        if (sub) sub.style.display = "block";

        const byId = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
        byId("profName", name);
        byId("profMail", data.email || "‚Äî");
        byId("profXp",   data.xp ?? 0);
        byId("profCreated", data.createdAt?.toDate?.().toLocaleDateString("fr-FR") || "‚Äî");
      }
    } catch(e){ console.warn("Firestore load error", e); }
  });
</script>
</body>
</html>
